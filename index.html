<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Life OS: Unified Intelligence</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            background-color: #020617; /* Slate 950 */
            color: #e2e8f0; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none;
            font-family: "Noto Sans TC", sans-serif;
        }
        .font-mono { font-family: "JetBrains Mono", monospace; }
        
        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(100, 116, 139, 0.5); border-radius: 2px; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Date Input Styling Override */
        input[type="date"] {
            color-scheme: dark;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Activity, Archive, BrainCircuit, Database, Shield, Zap, Trash2, Plus, 
            ArrowRight, Sparkles, Loader2, AlertTriangle, CheckCircle, X,
            BookOpen, Eye, LogIn, LogOut, Settings, History, MapPin, 
            Calendar, Star, Globe, Heart, Book, LayoutGrid, Radio, Hexagon,
            GitMerge, GitCompare, Info, MessageSquare, HelpCircle, User, Cloud, Save, RefreshCw, PenTool, StickyNote, CornerDownLeft, Coffee, Compass, Lightbulb, Library, Landmark, Youtube
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from 'firebase/auth';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, setDoc, onSnapshot, serverTimestamp, query, orderBy, where } from 'firebase/firestore';

        // --- Firebase Configuration Logic ---
        const DEFAULT_CONFIG = {
            apiKey: "AIzaSyAgNktz8JUCOglOtB-zyle-FSfIV0TbVRc",
            authDomain: "blackbox-48253.firebaseapp.com",
            projectId: "blackbox-48253",
            storageBucket: "blackbox-48253.firebasestorage.app",
            messagingSenderId: "349317379720",
            appId: "1:349317379720:web:e006daa4643c5310ebd13d"
        };

        let firebaseConfig = DEFAULT_CONFIG;
        try {
            const storedConfig = localStorage.getItem('custom_firebase_config');
            if (storedConfig) {
                firebaseConfig = JSON.parse(storedConfig);
            } else if (typeof __firebase_config !== 'undefined') {
                 firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) { console.error("Config load error", e); }

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Firebase init error", e); }
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'life-os-unified-v3';
        const provider = new GoogleAuthProvider();

        // --- Settings Modal ---
        const SettingsModal = ({ onClose }) => {
            const [configInput, setConfigInput] = useState('');
            useEffect(() => {
                const stored = localStorage.getItem('custom_firebase_config');
                if (stored) setConfigInput(stored);
            }, []);
            const handleSave = () => {
                try {
                    if (!configInput.trim()) localStorage.removeItem('custom_firebase_config');
                    else localStorage.setItem('custom_firebase_config', JSON.stringify(JSON.parse(configInput)));
                    alert("è¨­å®šå·²å„²å­˜ï¼é‡å•Ÿä¸­..."); window.location.reload();
                } catch (e) { alert("JSON æ ¼å¼éŒ¯èª¤"); }
            };
            const handleReset = () => {
                if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) { localStorage.removeItem('custom_firebase_config'); window.location.reload(); }
            };
            return (
                <div className="fixed inset-0 z-[110] bg-slate-950/95 backdrop-blur flex flex-col items-center justify-center p-6 animate-fade-in">
                    <div className="bg-slate-900 border border-slate-800 rounded-xl w-full max-w-md p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-white font-bold flex items-center gap-2"><Settings size={18} /> ç³»çµ±è¨­å®š</h3>
                            <button onClick={onClose}><X size={20} className="text-slate-500 hover:text-white"/></button>
                        </div>
                        <div className="mb-6">
                            <label className="text-xs font-bold text-slate-400 mb-2 block">Firebase Configuration (JSON)</label>
                            <textarea value={configInput} onChange={e => setConfigInput(e.target.value)} className="w-full h-32 bg-slate-950 border border-slate-700 rounded p-3 text-xs font-mono text-slate-300 focus:outline-none focus:border-cyan-500" placeholder='{"apiKey": "AIza...", ...}' />
                        </div>
                        <div className="flex gap-3">
                            <button onClick={handleReset} className="flex-1 py-2 text-xs font-bold text-rose-400 border border-rose-500/30 rounded hover:bg-rose-500/10">é‡ç½®</button>
                            <button onClick={handleSave} className="flex-1 py-2 text-xs font-bold text-white bg-cyan-600 rounded hover:bg-cyan-500 flex items-center justify-center gap-2"><Save size={14}/> å„²å­˜</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- System Manual (Full Detailed Version) ---
        const SystemManual = ({ onClose }) => {
            const [tab, setTab] = useState('core');
            return (
                <div className="fixed inset-0 z-[100] bg-slate-950/95 backdrop-blur flex flex-col animate-fade-in">
                    <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-950">
                        <div className="flex items-center gap-2"><BookOpen className="text-cyan-400" size={20} /><h2 className="text-lg font-bold text-white tracking-wider">SYSTEM MANUAL</h2></div>
                        <button onClick={onClose} className="p-2 hover:bg-slate-800 rounded-full transition-colors"><X size={24} className="text-slate-500" /></button>
                    </div>
                    <div className="flex border-b border-slate-800 bg-slate-900/50 overflow-x-auto custom-scrollbar">
                        <button onClick={() => setTab('core')} className={`flex-1 min-w-[80px] py-3 text-xs font-bold transition-colors ${tab === 'core' ? 'text-cyan-400 border-b-2 border-cyan-400 bg-cyan-500/5' : 'text-slate-500'}`}>æ ¸å¿ƒè§€å¿µ</button>
                        <button onClick={() => setTab('guide')} className={`flex-1 min-w-[80px] py-3 text-xs font-bold transition-colors ${tab === 'guide' ? 'text-emerald-400 border-b-2 border-emerald-400 bg-emerald-500/5' : 'text-slate-500'}`}>æ“ä½œæŒ‡å¼•</button>
                        <button onClick={() => setTab('faq')} className={`flex-1 min-w-[80px] py-3 text-xs font-bold transition-colors ${tab === 'faq' ? 'text-rose-400 border-b-2 border-rose-400 bg-rose-500/5' : 'text-slate-500'}`}>å¯¦æˆ°æƒ…å¢ƒ</button>
                    </div>
                    <div className="flex-1 overflow-y-auto custom-scrollbar p-6">
                        {tab === 'core' && (
                            <div className="space-y-8 max-w-2xl mx-auto animate-slide-up">
                                {/* 1. The Funnel */}
                                <div>
                                    <div className="text-center mb-6">
                                        <h3 className="text-xl font-bold text-white mb-2">å–®ä¸€å…¥å£ï¼Œé›™å‘å‡ºå£</h3>
                                        <p className="text-slate-400 text-sm">Life OS çš„æ ¸å¿ƒåœ¨æ–¼ã€Œä¸è®“å¤§è…¦åœ¨æ•æ‰ç•¶ä¸‹åšæ±ºç­–ã€ã€‚</p>
                                    </div>
                                    <div className="bg-slate-900 border border-slate-800 p-5 rounded-xl mb-6">
                                        <div className="flex items-center gap-3 mb-3 text-cyan-400"><Zap size={20} /><h4 className="font-bold">ç¬¬ä¸€æ­¥ï¼šLauncher (ç™¼å°„å°)</h4></div>
                                        <p className="text-sm text-slate-300 leading-relaxed">
                                            é€™æ˜¯æ‚¨çš„ã€Œé§•é§›è‰™ã€ã€‚ç•¶ä»»ä½•å¿µé ­é–ƒéâ€”â€”ç„¡è«–æ˜¯æƒ³é›¢è·çš„è¡å‹•ï¼Œé‚„æ˜¯çœ‹åˆ°å¤•é™½çš„æ„Ÿå‹•â€”â€”<strong className="text-white">å…ˆè¨˜ä¸‹ä¾†</strong>ã€‚ä¸è¦ç®¡å®ƒå»å“ªè£¡ï¼ŒæŠŠæ•æ‰çš„é˜»åŠ›é™åˆ°æœ€ä½ã€‚
                                        </p>
                                    </div>
                                </div>

                                {/* 2. The Logic & Split */}
                                <div className="flex flex-col md:flex-row gap-4 mb-6">
                                    {/* Left Brain: Black Box */}
                                    <div className="flex-1 bg-rose-950/20 border border-rose-900/30 p-5 rounded-xl flex flex-col">
                                        <div className="flex items-center gap-3 mb-3 text-rose-400"><BrainCircuit size={20} /><h4 className="font-bold">å·¦è…¦ï¼šé»‘ç›’å­</h4></div>
                                        <p className="text-xs text-rose-200/70 leading-relaxed mb-4">
                                            è™•ç†<strong>ã€Œè² å‘è¨Šè™Ÿã€</strong>ã€‚é€™è£¡æ˜¯ç‚ºäº†<strong className="text-rose-400">é™¤éŒ¯ (Debug)</strong>ã€‚æˆ‘å€‘è¨˜éŒ„ç—›è‹¦ä¸æ˜¯ç‚ºäº†åèŠ»ï¼Œè€Œæ˜¯ç‚ºäº†æ‰¾å‡º Patternï¼Œç„¶å¾Œæ¶ˆæ»…å®ƒã€‚
                                        </p>
                                        
                                        {/* Internal Logic Moved Here */}
                                        <div className="mt-auto bg-slate-950/50 rounded-lg p-3 border border-rose-500/10">
                                            <div className="text-[10px] font-bold text-slate-500 mb-2 uppercase tracking-wide">å°ˆå±¬æ©Ÿåˆ¶</div>
                                            <div className="space-y-3">
                                                <div className="flex gap-2">
                                                    <Activity size={14} className="text-rose-400 shrink-0 mt-0.5"/>
                                                    <div>
                                                        <span className="text-rose-400 text-xs font-bold block">RECURRED (å†ç™¼)</span>
                                                        <span className="text-[10px] text-slate-400">è¨ˆæ•¸å™¨ã€‚åªæœ‰ç•¶å£äº‹<strong className="text-slate-200">çœŸçš„ç™¼ç”Ÿ</strong>æ™‚æ‰æŒ‰ã€‚</span>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <StickyNote size={14} className="text-indigo-400 shrink-0 mt-0.5"/>
                                                    <div>
                                                        <span className="text-indigo-400 text-xs font-bold block">MEMO (ç­†è¨˜)</span>
                                                        <span className="text-[10px] text-slate-400">æˆ°è¡“æ¿ã€‚æ€è€ƒå°ç­–æ™‚ä½¿ç”¨ï¼Œ<strong className="text-slate-200">ä¸å¢åŠ è¨ˆæ•¸</strong>ã€‚</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Right Brain: Archive */}
                                    <div className="flex-1 bg-emerald-950/20 border border-emerald-900/30 p-5 rounded-xl">
                                        <div className="flex items-center gap-3 mb-3 text-emerald-400"><Archive size={20} /><h4 className="font-bold">å³è…¦ï¼šæª”æ¡ˆé¤¨</h4></div>
                                        <p className="text-xs text-emerald-200/70 leading-relaxed">
                                            è™•ç†<strong>ã€Œæ­£å‘å›æ†¶ã€</strong>ã€‚é€™è£¡æ˜¯ç‚ºäº†<strong className="text-emerald-400">ç­–å±• (Curate)</strong>ã€‚æˆ‘å€‘è¨˜éŒ„ç¾å¥½æ˜¯ç‚ºäº†åœ¨æœªä¾†ä½æ½®æ™‚ï¼Œæœ‰èƒ½é‡å¯ä»¥æå–ã€‚
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}
                        {tab === 'guide' && (
                            <div className="space-y-6 max-w-2xl mx-auto animate-slide-up">
                                <div className="p-5 rounded-xl border border-rose-900/30 bg-rose-950/10">
                                    <h3 className="text-rose-400 font-bold mb-4 flex items-center gap-2"><BrainCircuit size={18}/> é»‘ç›’å­æ“ä½œæŒ‡å¼•</h3>
                                    <ul className="space-y-4 text-sm text-slate-300">
                                        <li className="flex gap-3"><span className="text-rose-400 font-bold">1.</span> <div><strong className="text-white block mb-1">æ•æ‰ (Capture)</strong>è¨˜éŒ„ä»»ä½•è®“æ‚¨æ„Ÿåˆ°ã€Œå¡å¡çš„ã€äº‹æƒ…ã€‚ä¾‹å¦‚ï¼šã€Œé–‹æœƒæ™‚è¢«æ’å˜´ï¼Œè¦ºå¾—ä¸å—å°Šé‡ã€ã€‚</div></li>
                                        <li className="flex gap-3"><span className="text-rose-400 font-bold">2.</span> <div><strong className="text-white block mb-1">è¨ˆæ•¸ (Count)</strong>å¦‚æœåŒæ¨£çš„äº‹æƒ…å†æ¬¡ç™¼ç”Ÿï¼Œé»æ“Š <span className="text-rose-400 border border-rose-700 px-1 rounded text-[10px] bg-rose-900/20">RECURRED</span>ã€‚åŸå‰‡ï¼šç™¼ç”Ÿä¸€æ¬¡æ˜¯æ„å¤–ï¼Œç™¼ç”Ÿä¸‰æ¬¡å°±æ˜¯æ¨¡å¼ã€‚</div></li>
                                        <li className="flex gap-3"><span className="text-rose-400 font-bold">3.</span> <div><strong className="text-white block mb-1">è½‰åŒ– (Solve)</strong>ç•¶æ‚¨æ‰¾åˆ°è§£æ±ºæ–¹æ³•ï¼ˆæˆ–æ±ºå®šè¨­ä¸‹ç•Œç·šï¼‰ï¼Œé»æ“Š <span className="text-emerald-500 border border-emerald-500/30 px-1 rounded text-[10px] bg-emerald-900/20">âœ… SOLVED</span>ã€‚å®ƒæœƒè®Šæˆä¸€æ¢æ°¸ä¹…çš„ã€Œå”è­° (Protocol)ã€ï¼Œä¸¦å„²å­˜åœ¨é»‘ç›’å­åº•éƒ¨çš„åˆ—è¡¨ä¸­ï¼Œä½œç‚ºæ‚¨çš„äººç”Ÿæ™ºæ…§åº«ã€‚</div></li>
                                    </ul>
                                </div>

                                <div className="p-5 rounded-xl border border-emerald-900/30 bg-emerald-950/10">
                                    <h3 className="text-emerald-400 font-bold mb-4 flex items-center gap-2"><Archive size={18}/> æª”æ¡ˆé¤¨æ“ä½œæŒ‡å¼•ï¼šé›™æ ¸æ¶æ§‹</h3>
                                    
                                    <div className="grid grid-cols-2 gap-0 mb-4 rounded-lg overflow-hidden border border-slate-700">
                                        <div className="bg-emerald-900/20 p-3 text-center border-r border-slate-700">
                                            <div className="flex justify-center mb-1 text-emerald-400"><Landmark size={18}/></div>
                                            <h4 className="text-xs font-bold text-emerald-300 mb-1">åšç‰©é¤¨ (Museum)</h4>
                                            <p className="text-[9px] text-slate-400">é«”é©— / æ„Ÿæ€§ / æœ‰æ™‚é–“æ€§</p>
                                            <div className="mt-2 flex flex-wrap gap-1 justify-center">
                                                <span className="text-[9px] border border-emerald-500/30 text-emerald-500 px-1 rounded">æ—…éŠ</span>
                                                <span className="text-[9px] border border-rose-500/30 text-rose-500 px-1 rounded">æƒ…æ„Ÿ</span>
                                                <span className="text-[9px] border border-indigo-500/30 text-indigo-500 px-1 rounded">å›æ†¶</span>
                                            </div>
                                        </div>
                                        <div className="bg-violet-900/20 p-3 text-center">
                                            <div className="flex justify-center mb-1 text-violet-400"><Library size={18}/></div>
                                            <h4 className="text-xs font-bold text-violet-300 mb-1">åœ–æ›¸é¤¨ (Library)</h4>
                                            <p className="text-[9px] text-slate-400">çŸ¥è­˜ / ç†æ€§ / æ°¸æ†</p>
                                            <div className="mt-2 flex flex-wrap gap-1 justify-center">
                                                <span className="text-[9px] border border-violet-500/30 text-violet-500 px-1 rounded">æ´è¦‹</span>
                                                <span className="text-[9px] border border-amber-500/30 text-amber-500 px-1 rounded">é‡Œç¨‹ç¢‘</span>
                                            </div>
                                        </div>
                                    </div>

                                    <ul className="space-y-4 text-sm text-slate-300">
                                        <li className="flex gap-3"><span className="text-emerald-400 font-bold">1.</span> <div><strong className="text-white block mb-1">æ”¶é›† (Breadcrumbs)</strong>ä¸éœ€è¦å¯«é•·ç¯‡æ—¥è¨˜ã€‚åªè¦è¨˜ä¸‹ã€Œé—œéµå­—ã€æˆ–ã€Œä¸€å¥è©±ã€ã€‚ä¾‹å¦‚ï¼šã€Œä»Šå¤©åœ¨è—ç“¶å’–å•¡ï¼Œé™½å…‰å¾ˆå¥½ã€‚ã€</div></li>
                                        <li className="flex gap-3"><span className="text-emerald-400 font-bold">2.</span> <div><strong className="text-white block mb-1">åèŠ» (Reflect)</strong>ç•¶æ‚¨å›é¡§èˆŠå›æ†¶æœ‰æ–°æƒ³æ³•æ™‚ï¼Œä¸éœ€è¦ä¿®æ”¹åŸæ–‡ï¼Œè€Œæ˜¯ä½¿ç”¨ã€ŒåèŠ»ã€åŠŸèƒ½ï¼Œåœ¨ä¸‹æ–¹æ·»åŠ æ–°çš„è§€é»ï¼ˆå¦‚ï¼šã€Œç¾åœ¨çœ‹ç•¶æ™‚çš„æŒ«æŠ˜ï¼Œå…¶å¯¦æ˜¯è½‰æ©Ÿã€ï¼‰ã€‚</div></li>
                                        <li className="flex gap-3"><span className="text-emerald-400 font-bold">3.</span> <div><strong className="text-white block mb-1">ç­–å±• (Curate)</strong>æ¯éä¸€æ®µæ™‚é–“ï¼ˆå¦‚ä¸‰å€‹æœˆï¼‰ï¼Œæ‰“é–‹æª”æ¡ˆé¤¨ç€è¦½ã€‚é€™äº›é»é»æ»´æ»´æœƒé€£æˆç·šï¼Œè®“æ‚¨çœ‹åˆ°è‡ªå·±æˆé•·çš„è»Œè·¡ã€‚</div></li>
                                    </ul>
                                </div>
                            </div>
                        )}
                        {tab === 'faq' && (
                            <div className="space-y-6 max-w-2xl mx-auto animate-slide-up">
                                <div className="bg-amber-500/10 border border-amber-500/20 p-5 rounded-xl">
                                    <h3 className="text-amber-400 font-bold mb-3 flex items-center gap-2"><HelpCircle size={18}/> æ¡ˆä¾‹ä¸€ï¼šè€é—†ç•«é¤…</h3>
                                    <p className="text-sm text-slate-300 mb-4">
                                        Q: ã€Œè€é—†èªªæœ‰æ–°æ¡ˆå­ï¼Œå¦‚æœèªªäº†å¾ˆå¤šæ¬¡ä½†éƒ½æ²’ç™¼ç”Ÿï¼Œæˆ‘è‡ªå·±è¦æƒ³æ‡‰å°æ–¹æ³•ï¼›ä½†å¦‚æœçœŸçš„æœ‰ç™¼ç”Ÿåˆè©²æ€éº¼è¨˜éŒ„å‘¢ï¼Ÿã€
                                    </p>
                                    <div className="space-y-2 text-sm text-slate-300">
                                        <div className="p-2 border-l-2 border-rose-500 pl-3">ğŸ”´ <strong>æ²’å¯¦ç¾ (Bug)ï¼š</strong> å±¬æ–¼é»‘ç›’å­ã€‚æ¯æ¬¡æ²’å¯¦ç¾å°±é» <span className="text-rose-400 font-bold">RECURRED</span>ã€‚</div>
                                        <div className="p-2 border-l-2 border-emerald-500 pl-3">ğŸŸ¢ <strong>å¯¦ç¾äº† (Feature)ï¼š</strong> å±¬æ–¼é»‘ç›’å­ <span className="text-emerald-400 font-bold">SOLVED</span> (é©—è­‰æˆåŠŸ) + æª”æ¡ˆé¤¨ <strong className="text-emerald-400">é‡Œç¨‹ç¢‘</strong> (æ…¶ç¥)ã€‚</div>
                                    </div>
                                </div>

                                <div className="bg-indigo-500/10 border border-indigo-500/20 p-5 rounded-xl">
                                    <h3 className="text-indigo-400 font-bold mb-3 flex items-center gap-2"><HelpCircle size={18}/> æ¡ˆä¾‹äºŒï¼šç´™æœ¬ç­†è¨˜</h3>
                                    <p className="text-sm text-slate-300 mb-4">
                                        Q: ã€Œé‚£å¦‚æœæ˜¯ä»¥å‰çš„ç´™æœ¬ç­†è¨˜å‘¢ï¼Œæˆ‘æ‡‰è©²è¦æ€éº¼æ•´ç†å‘¢ï¼Ÿã€
                                    </p>
                                    <div className="space-y-2 text-xs text-slate-400 leading-relaxed">
                                        <p><strong className="text-white">1. ç¿»é–±èˆ‡æ„Ÿå—ï¼š</strong> å¿«é€Ÿç¿»é–±èˆŠç­†è¨˜ã€‚</p>
                                        <p><strong className="text-white">2. èƒå– (Extract)ï¼š</strong> åªæœ‰é‚£äº›ã€Œç¾åœ¨çœ‹é‚„æœ‰æ„Ÿè¦ºã€æˆ–ã€Œä¸æƒ³å¿˜è¨˜ã€çš„å…§å®¹æ‰éœ€è¦ç•™ã€‚å°‡å®ƒå€‘è¼¸å…¥é€²<strong className="text-emerald-400">æª”æ¡ˆé¤¨</strong>ï¼Œ<strong className="text-amber-400">è¨˜å¾—å°‡æ—¥æœŸè¨­å®šç‚ºç•¶å¹´çš„æ™‚é–“</strong>ã€‚</p>
                                        <p><strong className="text-white">3. éŠ·æ¯€ (Destroy)ï¼š</strong> ç¢ºèªæ•¸ä½åŒ–å¾Œï¼Œæœæ–·ä¸Ÿæ£„ç´™æœ¬ã€‚æª”æ¡ˆé¤¨æ˜¯ç²¾è¯å€ï¼Œä¸æ˜¯å€‰åº«ï¼›ç´™æœ¬ä½”æ“šçš„ç©ºé–“æ‡‰è©²ç•™çµ¦æœªä¾†ã€‚</p>
                                    </div>
                                </div>

                                <div className="bg-violet-500/10 border border-violet-500/20 p-5 rounded-xl">
                                    <h3 className="text-violet-400 font-bold mb-3 flex items-center gap-2"><Youtube size={18}/> æ¡ˆä¾‹ä¸‰ï¼šå¤–éƒ¨å­¸ç¿’ (YouTube/é–±è®€)</h3>
                                    <p className="text-sm text-slate-300 mb-4">
                                        Q: ã€Œæˆ‘çœ‹ YouTube å½±ç‰‡å­¸åˆ°ä¸€å€‹ B2B è§€å¿µï¼Œå¾ˆæœ‰æ”¶ç©«ï¼Œè©²æ€éº¼è¨˜ï¼Ÿã€
                                    </p>
                                    <div className="space-y-2 text-sm text-slate-300">
                                        <div className="p-2 border-l-2 border-violet-500 pl-3">
                                            <strong className="text-violet-300">æ­¥é©Ÿ 1ï¼šåˆ¤æ–·</strong><br/>
                                            é€™ä¸æ˜¯è¦è§£æ±ºçš„å•é¡Œ (éé»‘ç›’å­)ï¼Œé€™æ˜¯æœªä¾†çš„è³‡ç”¢ (æª”æ¡ˆé¤¨)ã€‚é›–ç„¶ä¾†æºæ˜¯å¤–éƒ¨ï¼Œä½†å…±é³´æ˜¯å…§éƒ¨çš„ã€‚
                                        </div>
                                        <div className="p-2 border-l-2 border-violet-500 pl-3">
                                            <strong className="text-violet-300">æ­¥é©Ÿ 2ï¼šè¨˜éŒ„</strong><br/>
                                            é€²å…¥æª”æ¡ˆé¤¨ï¼Œé¡åˆ¥é¸æ“‡ <span className="text-violet-400 font-bold">ğŸ§  æ´è¦‹ (Insight)</span>ã€‚æ¨™é¡Œå¯«ä¸‹è§€å¿µæ ¸å¿ƒï¼ˆå¦‚ã€Œè§€å¿µï¼šåƒç¶“ç‡Ÿ B2B ä¸€æ¨£ç¶“ç‡Ÿè·å ´ã€ï¼‰ã€‚
                                        </div>
                                        <div className="p-2 border-l-2 border-violet-500 pl-3">
                                            <strong className="text-violet-300">æ­¥é©Ÿ 3ï¼šèƒå–</strong><br/>
                                            åœ¨å…§å®¹è™•ï¼Œä¸è¦è²¼é€å­—ç¨¿ã€‚åªå¯«ä¸‹<strong className="text-white">ã€Œç‚ºä»€éº¼é€™é»å°æˆ‘æœ‰å•Ÿç™¼ï¼Ÿã€</strong>ä»¥åŠ<strong className="text-white">ã€Œæˆ‘æ‰“ç®—æ€éº¼ç”¨ï¼Ÿã€</strong>ã€‚
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- Main Components ---

        const Launcher = ({ onRoute, patternsCount, archivesCount, onOpenManual, onOpenSettings, user, onLogin, focus, onUpdateFocus }) => {
            const [input, setInput] = useState('');
            const [editingFocus, setEditingFocus] = useState(false);
            const [tempFocus, setTempFocus] = useState('');

            useEffect(() => { setTempFocus(focus); }, [focus]);

            const handleRouting = (target) => {
                if (!input.trim()) { onRoute(target, null); return; }
                onRoute(target, { text: input, timestamp: new Date() }); setInput('');
            };

            const saveFocus = () => {
                onUpdateFocus(tempFocus);
                setEditingFocus(false);
            };

            return (
                <div className="flex flex-col h-full p-6 animate-fade-in relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-rose-500 via-slate-800 to-emerald-500 opacity-50"></div>
                    
                    {/* Compact Status Bar */}
                    <div className="flex justify-between items-center mb-6 relative z-10">
                        <div className="flex items-center gap-4">
                            <div><h1 className="text-xl font-black tracking-tighter text-white">LIFE <span className="text-slate-500 font-light">OS</span></h1></div>
                        </div>
                        <div className="flex items-center gap-2">
                            {user?.isAnonymous ? <button onClick={onLogin} className="bg-slate-800 text-slate-400 p-2 rounded-full hover:text-white transition-colors" title="ç™»å…¥åŒæ­¥"><LogIn size={16}/></button> : <div className="text-emerald-500 p-2" title="å·²åŒæ­¥"><Cloud size={16} /></div>}
                            <button onClick={onOpenSettings} className="p-2 text-slate-500 hover:text-slate-300 transition-colors"><Settings size={16} /></button>
                            <button onClick={onOpenManual} className="p-2 text-cyan-500 hover:text-cyan-300 transition-colors"><BookOpen size={16} /></button>
                        </div>
                    </div>

                    {/* Stats Grid */}
                    <div className="grid grid-cols-2 gap-4 mb-6">
                        <div className="bg-rose-950/20 border border-rose-900/30 rounded-xl p-4 text-center">
                            <div className="text-2xl font-black text-rose-400 mb-1">{patternsCount}</div>
                            <div className="text-[10px] text-rose-300/60 font-bold tracking-wider">ACTIVE SIGNALS</div>
                        </div>
                        <div className="bg-emerald-950/20 border border-emerald-900/30 rounded-xl p-4 text-center">
                            <div className="text-2xl font-black text-emerald-400 mb-1">{archivesCount}</div>
                            <div className="text-[10px] text-emerald-300/60 font-bold tracking-wider">MEMORIES</div>
                        </div>
                    </div>

                    {/* Strategic Compass (New) */}
                    <div className="mb-8 relative z-10">
                        <div className="flex items-center gap-2 mb-2">
                            <Compass size={14} className="text-amber-400" />
                            <span className="text-[10px] font-bold text-amber-500 uppercase tracking-widest">Strategic Compass (åŒ—æ¥µæ˜Ÿ)</span>
                        </div>
                        <div className="bg-slate-900/50 border border-slate-700/50 rounded-lg p-1 flex items-center">
                            {editingFocus ? (
                                <input 
                                    autoFocus
                                    type="text" 
                                    value={tempFocus}
                                    onChange={(e) => setTempFocus(e.target.value)}
                                    onBlur={saveFocus}
                                    onKeyDown={(e) => e.key === 'Enter' && saveFocus()}
                                    className="w-full bg-slate-950 text-slate-200 text-xs px-3 py-2 rounded focus:outline-none focus:ring-1 focus:ring-amber-500/50"
                                    placeholder="è¼¸å…¥æœ¬å­£æ ¸å¿ƒç›®æ¨™..."
                                />
                            ) : (
                                <div 
                                    onClick={() => setEditingFocus(true)}
                                    className={`w-full px-3 py-2 text-xs cursor-pointer truncate ${!focus ? 'text-slate-600 italic' : 'text-slate-300 font-medium'}`}
                                >
                                    {focus || "é»æ“Šè¨­å®šç•¶å‰èˆªå‘..."}
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col justify-start relative z-10 max-w-lg mx-auto w-full pt-2">
                        <label className="text-slate-400 text-sm mb-4 font-medium flex items-center gap-2 animate-pulse"><Zap size={16} className="text-amber-400" /> æ­£åœ¨ç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ</label>
                        
                        <div className="relative group mb-8"><div className="absolute -inset-0.5 bg-gradient-to-r from-rose-500/50 to-emerald-500/50 rounded-xl blur opacity-30 group-hover:opacity-60 transition duration-500"></div><textarea value={input} onChange={e => setInput(e.target.value)} placeholder="æ•æ‰ç•¶ä¸‹çš„å¿µé ­..." className="relative w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-lg text-white placeholder:text-slate-600 focus:outline-none focus:border-slate-500 min-h-[140px] resize-none shadow-2xl" /></div>
                        
                        <div className="grid grid-cols-2 gap-4">
                            <button onClick={() => handleRouting('blackbox')} className="group relative p-4 rounded-xl border border-rose-900/30 bg-rose-950/20 hover:bg-rose-900/30 transition-all text-left overflow-hidden"><div className="absolute inset-0 bg-gradient-to-br from-rose-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div><div className="mb-2 w-10 h-10 rounded-lg bg-rose-500/10 flex items-center justify-center text-rose-400 relative z-10"><Activity size={20} /></div><h3 className="text-rose-200 font-bold relative z-10">è² å‘è¨Šè™Ÿ</h3><p className="text-rose-500/60 text-xs mt-1 relative z-10">ç„¦æ…® / æ†¤æ€’ / å•é¡Œ</p></button>
                            <button onClick={() => handleRouting('archive')} className="group relative p-4 rounded-xl border border-emerald-900/30 bg-emerald-950/20 hover:bg-emerald-900/30 transition-all text-left overflow-hidden"><div className="absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div><div className="mb-2 w-10 h-10 rounded-lg bg-emerald-500/10 flex items-center justify-center text-emerald-400 relative z-10"><Archive size={20} /></div><h3 className="text-emerald-200 font-bold relative z-10">æ­£å‘å›æ†¶</h3><p className="text-emerald-500/60 text-xs mt-1 relative z-10">é–‹å¿ƒ / éˆæ„Ÿ / é‡Œç¨‹ç¢‘</p></button>
                        </div>
                    </div>
                </div>
            );
        };

        const BlackBoxModule = ({ user, incomingData, onClearIncoming }) => {
            const [patterns, setPatterns] = useState([]);
            const [protocols, setProtocols] = useState([]);
            const [input, setInput] = useState('');
            const [interactingId, setInteractingId] = useState(null); 
            const [interactionType, setInteractionType] = useState(null); // 'recur' | 'solve' | 'memo'
            const [actionNote, setActionNote] = useState('');
            const [protocolRule, setProtocolRule] = useState('');

            useEffect(() => {
                if (incomingData) { addPattern(incomingData.text); onClearIncoming(); }
            }, [incomingData]);

            useEffect(() => {
                if (!user) return;
                const qP = query(collection(db, 'artifacts', appId, 'users', user.uid, 'patterns'), orderBy('count', 'desc'));
                const unsubP = onSnapshot(qP, snap => setPatterns(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                const qPro = query(collection(db, 'artifacts', appId, 'users', user.uid, 'protocols'), orderBy('createdAt', 'desc'));
                const unsubPro = onSnapshot(qPro, snap => setProtocols(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                return () => { unsubP(); unsubPro(); };
            }, [user]);

            const addPattern = async (text) => {
                if (!text || !user) return;
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'patterns'), {
                    text, count: 1, logs: [{ timestamp: new Date().toISOString(), note: 'First detected' }], status: 'active', createdAt: serverTimestamp()
                });
            };

            const deletePattern = async (id) => {
                if (!user) return;
                if (confirm('ç¢ºå®šè¦åˆªé™¤é€™æ¢è¨Šè™Ÿå—ï¼Ÿ(æ­¤å‹•ä½œç„¡æ³•å¾©åŸ)')) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'patterns', id));
                }
            };

            const deleteProtocol = async (id) => {
                if (!user) return;
                if (confirm('ç¢ºå®šè¦åˆªé™¤é€™æ¢å”è­°å—ï¼Ÿ')) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'protocols', id));
                }
            };

            const handleInteraction = (id, type) => {
                if (interactingId === id && interactionType === type) { setInteractingId(null); setInteractionType(null); } 
                else { setInteractingId(id); setInteractionType(type); setActionNote(''); setProtocolRule(''); }
            };

            const executeAction = async (pattern) => {
                if (!user) return;
                try {
                    const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'patterns', pattern.id);
                    if (interactionType === 'recur') {
                        const note = actionNote.trim() || 'Recurred';
                        await updateDoc(ref, { count: pattern.count + 1, logs: [...(pattern.logs||[]), {timestamp: new Date().toISOString(), note: note}] });
                    } else if (interactionType === 'memo') { // MEMO LOGIC
                        const note = actionNote.trim();
                        if(!note) return alert("è«‹è¼¸å…¥ç­†è¨˜å…§å®¹");
                        await updateDoc(ref, { logs: [...(pattern.logs||[]), {timestamp: new Date().toISOString(), note: `ğŸ“ ${note}`}] }); // Count does NOT increase
                    } else if (interactionType === 'solve') {
                        const rule = protocolRule.trim();
                        if (!rule) { alert("è«‹è¼¸å…¥æ‚¨çš„ SOPï¼Œæˆ–æ”¹ç”¨ MEMO è¨˜éŒ„æ€è€ƒéç¨‹ã€‚"); return; }
                        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'protocols'), { trigger: pattern.text, type: 'strategic', rule: rule, createdAt: serverTimestamp() });
                        await deleteDoc(ref);
                    }
                    setInteractingId(null); setInteractionType(null); setActionNote(''); setProtocolRule('');
                } catch (error) { console.error(error); alert("Error"); }
            };

            return (
                <div className="h-full flex flex-col p-4 animate-fade-in">
                    <div className="flex items-center gap-2 mb-4 text-rose-400"><BrainCircuit size={20} /><h2 className="font-bold tracking-widest">BLACK BOX</h2></div>
                    <div className="flex gap-2 mb-6"><input type="text" value={input} onChange={e => setInput(e.target.value)} placeholder="åµæ¸¬æ–°è¨Šè™Ÿ..." className="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200 focus:border-rose-500 outline-none" onKeyDown={e => e.key === 'Enter' && (addPattern(input), setInput(''))} /><button onClick={() => {addPattern(input); setInput('')}} className="bg-rose-600/20 text-rose-400 p-2 rounded-lg hover:bg-rose-600/40"><Plus size={18}/></button></div>
                    <div className="flex-1 overflow-y-auto custom-scrollbar space-y-3 pb-20">
                        {patterns.length === 0 && <div className="text-center text-slate-600 text-xs py-10">NO ACTIVE SIGNALS</div>}
                        {patterns.map(p => (
                            <div key={p.id} className={`bg-slate-900/50 border ${p.count >= 3 ? 'border-rose-500/50 shadow-[0_0_15px_rgba(244,63,94,0.1)]' : 'border-slate-800'} p-4 rounded-xl transition-all`}>
                                <div className="flex justify-between items-start mb-2">
                                    <h3 className="text-slate-200 font-bold text-sm leading-relaxed">{p.text}</h3>
                                    <div className="flex items-center gap-3">
                                        <div className={`font-mono text-lg font-black ${p.count >= 3 ? 'text-rose-500' : 'text-slate-500'}`}>{p.count}</div>
                                        <button onClick={() => deletePattern(p.id)} className="text-slate-600 hover:text-rose-500 transition-colors"><Trash2 size={14}/></button>
                                    </div>
                                </div>
                                <div className="flex gap-2 mt-3">
                                    <button onClick={() => handleInteraction(p.id, 'solve')} className={`flex-1 py-2 rounded text-[10px] font-bold border transition-colors ${interactionType === 'solve' && interactingId === p.id ? 'bg-emerald-500 text-white border-emerald-500' : 'bg-emerald-500/10 text-emerald-500 border-emerald-500/20 hover:bg-emerald-500/20'}`}>âœ… SOLVED</button>
                                    <button onClick={() => handleInteraction(p.id, 'memo')} className={`flex-1 py-2 rounded text-[10px] font-bold border transition-colors ${interactionType === 'memo' && interactingId === p.id ? 'bg-indigo-500 text-white border-indigo-500' : 'bg-indigo-500/10 text-indigo-400 border-indigo-500/20 hover:bg-indigo-500/20'}`}>ğŸ“ MEMO</button>
                                    <button onClick={() => handleInteraction(p.id, 'recur')} className={`flex-1 py-2 rounded text-[10px] font-bold border transition-colors ${interactionType === 'recur' && interactingId === p.id ? 'bg-rose-900/30 text-rose-300 border-rose-800' : 'bg-slate-800 text-slate-400 border-slate-700 hover:bg-slate-700'}`}>RECURRED (+1)</button>
                                </div>
                                {interactingId === p.id && (
                                    <div className="mt-3 pt-3 border-t border-slate-700/50 animate-fade-in bg-slate-950/30 -mx-2 px-2 pb-2 rounded">
                                        {interactionType === 'solve' ? (
                                            <div className="text-left px-1">
                                                <div className="text-emerald-400 text-xs mb-2 font-bold flex items-center gap-1"><Sparkles size={12}/> è½‰åŒ–ç‚ºæ™ºæ…§å”è­° (Protocol)</div>
                                                <p className="text-[10px] text-slate-400 mb-2">æ—¢ç„¶å•é¡Œå·²è§£æ±ºï¼Œè«‹åˆ¶å®š SOPï¼Œé¿å…é‡è¹ˆè¦†å¾¹ã€‚æ‚¨å¯åƒè€ƒä¸‹æ–¹çš„ MEMOã€‚</p>
                                                
                                                {/* Reference Memos Section */}
                                                {p.logs && p.logs.some(l => l.note.startsWith('ğŸ“')) && (
                                                    <div className="mb-3 max-h-32 overflow-y-auto custom-scrollbar border border-indigo-500/20 rounded bg-indigo-500/5 p-2">
                                                        <div className="text-[9px] text-indigo-300 font-bold mb-1 flex items-center gap-1"><StickyNote size={10}/> éå»ç­†è¨˜ (é»æ“Šå¼•ç”¨)</div>
                                                        {p.logs.filter(l => l.note.startsWith('ğŸ“')).map((l, idx) => (
                                                            <button 
                                                                key={idx} 
                                                                onClick={() => setProtocolRule(prev => (prev ? prev + ' ' : '') + l.note.replace('ğŸ“ ', ''))}
                                                                className="text-[10px] text-slate-300 block w-full text-left hover:bg-indigo-500/10 p-1 rounded transition-colors flex items-start gap-1"
                                                            >
                                                                <CornerDownLeft size={10} className="mt-0.5 shrink-0 text-indigo-400"/>
                                                                {l.note.replace('ğŸ“ ', '')}
                                                            </button>
                                                        ))}
                                                    </div>
                                                )}

                                                <input autoFocus type="text" value={protocolRule} onChange={e => setProtocolRule(e.target.value)} placeholder="ä¾‹å¦‚ï¼šä¸‹æ¬¡é‡åˆ°ç•«é¤…ï¼Œç›´æ¥è¦æ±‚Emailç¢ºèª..." className="w-full bg-slate-900 border border-emerald-500/30 rounded px-2 py-2 text-xs text-white mb-2 focus:border-emerald-500 outline-none" onKeyDown={e => e.key === 'Enter' && executeAction(p)} />
                                                <button onClick={() => executeAction(p)} className="w-full bg-emerald-600 text-white py-2 rounded text-xs font-bold hover:bg-emerald-500">ç¢ºèªè½‰åŒ–ä¸¦æ­¸æª”</button>
                                            </div>
                                        ) : interactionType === 'memo' ? (
                                            <div className="text-left px-1">
                                                <label className="text-indigo-300 text-[10px] mb-1 block">è£œå……ç­†è¨˜ (ä¸å¢åŠ è¨ˆæ•¸)</label>
                                                <input autoFocus type="text" value={actionNote} onChange={e => setActionNote(e.target.value)} placeholder="æƒ³åˆ°ä»€éº¼å°ç­–ï¼Ÿæˆ–æ˜¯æœ‰ä»€éº¼æ–°ç™¼ç¾ï¼Ÿ" className="w-full bg-slate-900 border border-indigo-500/30 rounded px-2 py-2 text-xs text-white mb-2 focus:border-indigo-500 outline-none" onKeyDown={e => e.key === 'Enter' && executeAction(p)} />
                                                <button onClick={() => executeAction(p)} className="w-full bg-indigo-600 text-white py-2 rounded text-xs font-bold hover:bg-indigo-500">è¨˜éŒ„ç­†è¨˜ (SAVE NOTE)</button>
                                            </div>
                                        ) : (
                                            <div>
                                                <label className="text-slate-400 text-[10px] mb-1 block">é€™æ¬¡æ˜¯ç‚ºä»€éº¼ï¼Ÿ(é¸å¡«)</label>
                                                <input autoFocus type="text" value={actionNote} onChange={e => setActionNote(e.target.value)} placeholder="ä¾‹å¦‚ï¼šæ­£åœ¨æ€è€ƒå°ç­–..." className="w-full bg-slate-900 border border-slate-700 rounded px-2 py-2 text-xs text-white mb-2 focus:border-rose-500 outline-none" onKeyDown={e => e.key === 'Enter' && executeAction(p)} />
                                                <button onClick={() => executeAction(p)} className="w-full bg-slate-700 text-white py-2 rounded text-xs font-bold hover:bg-slate-600">ç¢ºèªè¨ˆæ•¸ (CONFIRM +1)</button>
                                            </div>
                                        )}
                                    </div>
                                )}
                                {p.logs && p.logs.length > 1 && (
                                    <div className="mt-3 space-y-1">
                                        {p.logs.slice().reverse().slice(0,3).map((log, i) => (
                                            <div key={i} className={`text-[10px] border-l-2 pl-2 ${log.note.includes('ğŸ“') ? 'border-indigo-500 text-indigo-300' : 'border-slate-700 text-slate-500'}`}>
                                                <span className="opacity-50 mr-2">{log.timestamp.split('T')[0]}</span>
                                                {log.note}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        ))}
                        <div className="mt-8 pt-4 border-t border-slate-800">
                            <h3 className="text-xs font-bold text-slate-500 mb-3 flex items-center gap-2"><Database size={12}/> PROTOCOLS (æ™ºæ…§åº«)</h3>
                            <div className="space-y-2">{protocols.map(pro => (
                                <div key={pro.id} className="text-[10px] bg-slate-900 p-3 rounded border border-slate-800 text-slate-400 flex flex-col gap-1 group hover:border-emerald-500/30 transition-colors">
                                    <div className="flex justify-between w-full">
                                        <strong className="text-slate-300">{pro.trigger}</strong>
                                        <div className="flex items-center gap-2">
                                            <span className="text-slate-600 text-[9px]">{new Date(pro.createdAt?.toDate ? pro.createdAt.toDate() : Date.now()).toLocaleDateString()}</span>
                                            <button onClick={() => deleteProtocol(pro.id)} className="text-slate-600 hover:text-rose-500"><Trash2 size={10}/></button>
                                        </div>
                                    </div>
                                    <div className="text-emerald-500/80 pl-2 border-l border-slate-700">â†³ {pro.rule}</div>
                                </div>))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ArchivesModule = ({ user, incomingData, onClearIncoming }) => {
            const [archives, setArchives] = useState([]);
            const [isAdding, setIsAdding] = useState(!!incomingData);
            const [newTitle, setNewTitle] = useState(incomingData ? (incomingData.text.length > 10 ? incomingData.text.substring(0,10)+'...' : incomingData.text) : '');
            const [newContent, setNewContent] = useState(incomingData ? incomingData.text : '');
            const [newType, setNewType] = useState('memory');
            const [newDate, setNewDate] = useState(new Date().toISOString().split('T')[0]);
            const [retroInputId, setRetroInputId] = useState(null);
            const [retroText, setRetroText] = useState('');

            useEffect(() => { if (incomingData) { setIsAdding(true); setNewContent(incomingData.text); setNewTitle(incomingData.text.split('\n')[0].substring(0, 20)); onClearIncoming(); } }, [incomingData]);
            useEffect(() => { if (!user) return; const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'archives'), orderBy('date', 'desc')); const unsub = onSnapshot(q, snap => setArchives(snap.docs.map(d => ({id: d.id, ...d.data()})))); return () => unsub(); }, [user]);

            const addArchive = async () => { if (!newContent.trim()) return; await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'archives'), { title: newTitle || 'æœªå‘½åå›æ†¶', content: newContent, date: newDate, type: newType, createdAt: serverTimestamp(), retrospectives: [] }); setIsAdding(false); setNewTitle(''); setNewContent(''); setNewDate(new Date().toISOString().split('T')[0]); };
            const addRetrospective = async (archiveId) => { if (!retroText.trim() || !user) return; const archive = archives.find(a => a.id === archiveId); await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'archives', archiveId), { retrospectives: [...(archive.retrospectives || []), { note: retroText, timestamp: new Date().toISOString() }] }); setRetroInputId(null); setRetroText(''); };
            
            const deleteArchive = async (id) => {
                if (!user) return;
                if (confirm('ç¢ºå®šè¦åˆªé™¤é€™æ®µå›æ†¶å—ï¼Ÿ(æ­¤å‹•ä½œç„¡æ³•å¾©åŸ)')) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'archives', id));
                }
            };

            const CATEGORIES = { 
                memory: { label: 'å›æ†¶', icon: Book, color: 'text-indigo-400', bg: 'bg-indigo-500/10', border: 'border-indigo-500/20', hover: 'hover:border-indigo-500/50 hover:shadow-[0_0_15px_rgba(99,102,241,0.1)]' }, 
                travel: { label: 'æ—…éŠ', icon: Globe, color: 'text-emerald-400', bg: 'bg-emerald-500/10', border: 'border-emerald-500/20', hover: 'hover:border-emerald-500/50 hover:shadow-[0_0_15px_rgba(52,211,153,0.1)]' }, 
                milestone: { label: 'é‡Œç¨‹ç¢‘', icon: Star, color: 'text-amber-400', bg: 'bg-amber-500/10', border: 'border-amber-500/20', hover: 'hover:border-amber-500/50 hover:shadow-[0_0_15px_rgba(251,191,36,0.1)]' }, 
                love: { label: 'æƒ…æ„Ÿ', icon: Heart, color: 'text-rose-400', bg: 'bg-rose-500/10', border: 'border-rose-500/20', hover: 'hover:border-rose-500/50 hover:shadow-[0_0_15px_rgba(251,113,133,0.1)]' },
                insight: { label: 'æ´è¦‹', icon: Lightbulb, color: 'text-violet-400', bg: 'bg-violet-500/10', border: 'border-violet-500/20', hover: 'hover:border-violet-500/50 hover:shadow-[0_0_15px_rgba(139,92,246,0.1)]' }
            };

            // Group by year logic
            const groupedArchives = useMemo(() => {
                const groups = {};
                archives.forEach(arc => {
                    const year = arc.date ? arc.date.split('-')[0] : 'Unknown';
                    if (!groups[year]) groups[year] = [];
                    groups[year].push(arc);
                });
                return Object.entries(groups).sort((a, b) => b[0] - a[0]); 
            }, [archives]);

            return (
                <div className="h-full flex flex-col p-4 animate-fade-in">
                    <div className="flex items-center gap-2 mb-4 text-emerald-400"><Archive size={20} /><h2 className="font-bold tracking-widest">ARCHIVES</h2></div>
                    {isAdding ? (
                        <div className="bg-slate-900 border border-emerald-500/30 p-4 rounded-xl mb-4 animate-fade-in shadow-xl">
                             <div className="flex flex-col gap-3 mb-3">
                                <div className="flex items-center gap-2 bg-slate-950 p-2 rounded border border-slate-700"><Calendar size={16} className="text-emerald-400" /><span className="text-xs text-slate-500 font-bold mr-2">æ—¥æœŸ:</span><input type="date" value={newDate} onChange={e => setNewDate(e.target.value)} className="bg-transparent text-sm text-white focus:outline-none w-full font-mono" /></div>
                                <input type="text" value={newTitle} onChange={e => setNewTitle(e.target.value)} placeholder="æ¨™é¡Œ (é¸å¡«)..." className="w-full bg-transparent text-white font-bold focus:outline-none border-b border-slate-700 focus:border-emerald-500 transition-colors py-2" />
                            </div>
                            <textarea value={newContent} onChange={e => setNewContent(e.target.value)} placeholder="å…§å®¹..." className="w-full bg-slate-950/50 p-3 rounded text-sm text-slate-300 min-h-[100px] mb-3 focus:outline-none resize-none border border-slate-800 focus:border-emerald-500/50" />
                            <div className="grid grid-cols-5 gap-2 mb-4">{Object.entries(CATEGORIES).map(([key, conf]) => { const Icon = conf.icon; return (<button key={key} onClick={() => setNewType(key)} className={`flex flex-col items-center justify-center py-2 rounded-lg border transition-all ${newType === key ? 'border-emerald-500 bg-emerald-500/20 text-emerald-300' : 'border-slate-700 bg-slate-800 text-slate-500'}`}><Icon size={16} className="mb-1" /><span className="text-[10px] font-bold">{conf.label}</span></button>); })}</div>
                            <div className="flex gap-2"><button onClick={() => setIsAdding(false)} className="flex-1 py-3 rounded bg-slate-800 text-slate-400 text-xs font-bold">å–æ¶ˆ</button><button onClick={addArchive} className="flex-1 py-3 rounded bg-emerald-600 text-white text-xs font-bold shadow-lg shadow-emerald-900/20">å­˜å…¥æª”æ¡ˆé¤¨</button></div>
                        </div>
                    ) : (
                        <button onClick={() => setIsAdding(true)} className="w-full py-3 mb-4 rounded-xl border border-dashed border-slate-700 text-slate-500 text-sm hover:border-emerald-500/50 hover:text-emerald-500 transition-colors flex items-center justify-center gap-2"><Plus size={16} /> æ–°å¢å›æ†¶ / è£œç™»èˆŠç­†è¨˜</button>
                    )}
                    <div className="flex-1 overflow-y-auto custom-scrollbar space-y-8 pb-20 p-2">
                        {archives.length === 0 && (
                            <div className="flex flex-col items-center justify-center py-20 opacity-50">
                                <Archive size={48} className="mb-4 text-emerald-500/50" />
                                <p className="text-sm">å°šç„¡å›æ†¶</p>
                                <p className="text-xs">è¨˜éŒ„ä¸‹ç¬¬ä¸€å€‹å€¼å¾—ç´€å¿µçš„ç¬é–“å§</p>
                            </div>
                        )}
                        {groupedArchives.map(([year, yearArchives]) => (
                            <div key={year} className="relative">
                                {/* Year Marker */}
                                <div className="sticky top-0 z-10 flex items-center gap-4 mb-6">
                                    <div className="text-4xl font-black text-slate-800/80 select-none">{year}</div>
                                    <div className="h-px bg-slate-800 flex-1"></div>
                                </div>
                                
                                <div className="space-y-6 pl-4 border-l-2 border-slate-800 ml-4">
                                    {yearArchives.map(arc => {
                                        const cat = CATEGORIES[arc.type] || CATEGORIES.memory; 
                                        const Icon = cat.icon;
                                        return (
                                            <div key={arc.id} className="relative pl-6 group">
                                                {/* Timeline Node */}
                                                <div className={`absolute -left-[25px] top-0 w-4 h-4 rounded-full border-2 border-slate-950 ${cat.bg} flex items-center justify-center box-content`}>
                                                    <div className={`w-1.5 h-1.5 rounded-full bg-current ${cat.color}`}></div>
                                                </div>
                                                
                                                {/* Card Content with Dynamic Frame Color */}
                                                <div className={`bg-slate-900 border ${cat.border} rounded-xl p-4 transition-all duration-300 ${cat.hover}`}>
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex items-center gap-2">
                                                            <span className={`text-[10px] px-2 py-0.5 rounded ${cat.bg} ${cat.color} font-bold flex items-center gap-1`}>
                                                                <Icon size={12} /> {cat.label}
                                                            </span>
                                                            <span className="text-[10px] text-slate-500 font-mono">{arc.date}</span>
                                                        </div>
                                                        <button onClick={() => deleteArchive(arc.id)} className="text-slate-600 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity p-1"><Trash2 size={14}/></button>
                                                    </div>
                                                    
                                                    {arc.title && <h3 className="text-white font-bold text-sm mb-2">{arc.title}</h3>}
                                                    <p className="text-xs text-slate-300 leading-relaxed whitespace-pre-wrap">{arc.content}</p>
                                                    
                                                    {arc.retrospectives && arc.retrospectives.length > 0 && (
                                                        <div className="mt-3 pt-2 border-t border-slate-800 space-y-2">
                                                            {arc.retrospectives.map((retro, idx) => (
                                                                <div key={idx} className="text-[10px] bg-slate-950/50 p-2 rounded flex gap-2">
                                                                    <div className="text-indigo-400 font-bold shrink-0">åèŠ»</div>
                                                                    <div className="text-slate-400 flex-1">
                                                                        {retro.note}
                                                                        <div className="text-[9px] text-slate-600 mt-1 text-right">{new Date(retro.timestamp).toLocaleDateString()}</div>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}

                                                    {retroInputId === arc.id ? (
                                                        <div className="mt-3 flex gap-2 animate-fade-in">
                                                            <input 
                                                                autoFocus
                                                                type="text" value={retroText} onChange={e => setRetroText(e.target.value)}
                                                                placeholder="å¯«ä¸‹æ–°çš„æƒ³æ³•..."
                                                                className="flex-1 bg-slate-950 border border-slate-700 rounded px-2 py-1.5 text-xs focus:border-emerald-500 outline-none"
                                                                onKeyDown={e => e.key === 'Enter' && addRetrospective(arc.id)}
                                                            />
                                                            <button onClick={() => addRetrospective(arc.id)} className="text-[10px] bg-emerald-600 px-3 rounded text-white font-bold hover:bg-emerald-500">ç¢ºèª</button>
                                                        </div>
                                                    ) : (
                                                        <button onClick={() => setRetroInputId(arc.id)} className="mt-3 text-[10px] text-slate-500 hover:text-emerald-400 flex items-center gap-1 transition-colors w-full justify-center py-1 rounded hover:bg-slate-800/50">
                                                            <MessageSquare size={12} /> æ·»åŠ åèŠ» (Reflect)
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('launcher'); 
            const [incomingData, setIncomingData] = useState(null);
            const [showManual, setShowManual] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [counts, setCounts] = useState({ patterns: 0, archives: 0 });
            const [focus, setFocus] = useState('');

            useEffect(() => {
                const initAuth = async () => {
                    if (!auth) return;
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) { console.error("Auth init failed:", error); }
                };
                initAuth();
                
                if(auth) {
                    const unsubscribe = onAuthStateChanged(auth, setUser);
                    return () => unsubscribe();
                }
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubP = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'patterns'), snap => { setCounts(prev => ({...prev, patterns: snap.size})); });
                const unsubA = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'archives'), snap => { setCounts(prev => ({...prev, archives: snap.size})); });
                const unsubF = onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'status'), snap => { if(snap.exists()) setFocus(snap.data().focus || ''); });
                
                return () => { unsubP(); unsubA(); unsubF(); };
            }, [user]);

            const handleRoute = (target, data) => { setIncomingData(data); setActiveTab(target); };
            const handleLogin = async () => { try { await signInWithPopup(auth, provider); } catch(e) { alert("ç™»å…¥å¤±æ•—: " + e.message); } };
            const handleUpdateFocus = async (newFocus) => { if(user) await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'status'), { focus: newFocus }, { merge: true }); };

            if (!user) return (<div className="h-[100dvh] flex flex-col items-center justify-center bg-slate-950 text-slate-400 p-8 text-center font-mono"><Hexagon size={48} className="text-slate-700 mb-4 animate-pulse" /><h1 className="text-2xl text-white font-bold mb-2">LIFE OS</h1><p className="text-sm mb-8">SYSTEM BOOT SEQUENCE...</p><button onClick={handleLogin} className="px-6 py-2 bg-slate-800 text-white rounded border border-slate-700 hover:border-slate-500 font-bold tracking-wide">IDENTIFY USER (LOGIN)</button><div className="mt-8"><button onClick={() => setShowSettings(true)} className="text-[10px] text-slate-600 hover:text-slate-400 flex items-center gap-1"><Settings size={10} /> CONFIGURATION</button></div>{showSettings && <SettingsModal onClose={() => setShowSettings(false)} />}</div>);

            return (
                <div className="h-[100dvh] bg-slate-950 flex flex-col max-w-md mx-auto shadow-2xl overflow-hidden border-x border-slate-900 relative">
                    <div className="flex-1 overflow-hidden relative bg-slate-950">
                        {showSettings && <SettingsModal onClose={() => setShowSettings(false)} />}
                        {showManual && <SystemManual onClose={() => setShowManual(false)} />}
                        {activeTab === 'launcher' && (<Launcher onRoute={handleRoute} patternsCount={counts.patterns} archivesCount={counts.archives} onOpenManual={() => setShowManual(true)} onOpenSettings={() => setShowSettings(true)} user={user} onLogin={handleLogin} focus={focus} onUpdateFocus={handleUpdateFocus} />)}
                        {activeTab === 'blackbox' && (<BlackBoxModule user={user} incomingData={incomingData} onClearIncoming={() => setIncomingData(null)} />)}
                        {activeTab === 'archive' && (<ArchivesModule user={user} incomingData={incomingData} onClearIncoming={() => setIncomingData(null)} />)}
                    </div>
                    <div className="h-16 bg-slate-900/90 backdrop-blur border-t border-slate-800 flex items-center justify-around px-4 shrink-0 z-50">
                        <button onClick={() => setActiveTab('blackbox')} className={`flex flex-col items-center gap-1 p-2 transition-colors ${activeTab === 'blackbox' ? 'text-rose-400 tab-active' : 'text-slate-600 hover:text-slate-400'}`}><BrainCircuit size={20} /><span className="text-[10px] font-bold tracking-wider">BLACKBOX</span></button>
                        <button onClick={() => setActiveTab('launcher')} className={`flex flex-col items-center gap-1 p-2 transition-colors ${activeTab === 'launcher' ? 'text-slate-200 -mt-8 bg-slate-800 border-4 border-slate-950 rounded-full w-14 h-14 flex justify-center shadow-lg' : 'text-slate-600 hover:text-slate-400'}`}><LayoutGrid size={24} /></button>
                        <button onClick={() => setActiveTab('archive')} className={`flex flex-col items-center gap-1 p-2 transition-colors ${activeTab === 'archive' ? 'text-emerald-400 tab-active' : 'text-slate-600 hover:text-slate-400'}`}><Archive size={20} /><span className="text-[10px] font-bold tracking-wider">ARCHIVE</span></button>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
